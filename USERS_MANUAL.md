# LRA1 Tool (Python版) ユーザーマニュアル

## 1. 概要

**LRA1 Tool** は、**LRA1** モジュールのファームウェア更新、検証、または初期化を行うツールです。  
本ツールはシリアル通信を介してデバイスに接続して、指定されたファームウェアファイルを転送または初期化します。  
また、DTRリセット機能により、適切なタイミングでデバイスのリセットが実行され、安定した更新が可能となります。  
※**LRA1** は [i2-electronics,Inc.](http://www.i2-ele.co.jp/) のLoRa通信モジュールです。

## 2. 対応モード

本ツールは以下の3つのモードで動作します。  
**注意:** モード指定のオプション（`-u`, `-v`, `-i`）がいずれも指定されない場合は、デフォルトでアップデートモード (`-u`) が採用されます。

- **アップデートモード (`-u`, `--update`)**  
  指定したファームウェアファイルをデバイスへ転送し、ファームウェアの更新を行います。

- **検証モード (`-v`, `--verify`)**  
  指定したファームウェアファイルとデバイス内のファームウェアを比較します。

- **初期化モード (`-i`, `--init`)**  
  各種設定値を出荷時の設定に戻します。  
  ただし、Flashに保存されたBASICプログラムは消去されません。  
  ※このモードではファームウェアファイルは不要です。

## 3. システム要件

- **動作環境:**  
  - Python 3.x  
  - Windows / macOS / Linux などの各種 OS

- **必要パッケージ:**  
  - [pySerial](https://pyserial.readthedocs.io/)  
    インストール方法:
    ```bash
    pip install pyserial
    ```

## 4. 使用方法

### 4.1 コマンドラインでの実行

ターミナル（またはコマンドプロンプト）を起動し、以下の形式で実行してください。

```
python lra1_tool.py -p <シリアルポート> [オプション]
```

#### 例:

- **アップデートモードの場合:**  
  ファームウェアファイルは `-f` または `--file` で指定します。
  ```bash
  python lra1_tool.py -p /dev/ttyS0 -u -f firmware.bin
  ```
  
- **検証モードの場合:**  
  ```bash
  python lra1_tool.py -p COM3 -v -f firmware.bin
  ```
  
- **初期化モードの場合:**  
  ファームウェアファイルの指定は不要です。
  ```bash
  python lra1_tool.py -p /dev/ttyS0 -i
  ```

### 4.2 各オプションの説明

- **`-p`, `--port`**  
  **必須**  
  使用するシリアルポートを指定します。  
  例: `/dev/ttyS0`、`COM3` など

- **`-r`, `--reset`**  
  オプション  
  転送前に DTR リセットを実行します。  
  ※デバイスのリセット動作が必要な場合に指定してください。

- **`-s`, `--swreset`**  
  オプション  
  転送前に "RESET" コマンドを送信します。  
  `-r` / `--reset` (DTRリセット) との併用が可能です。  

- **モードオプション**  
  以下のいずれか1つを指定してください。  
  ※指定がなければデフォルトで `-u` (アップデートモード) となります。
  - `-u`, `--update`  
    アップデートモードで動作します。  
    ※ファームウェアファイルの指定が必須です（`-f` オプション）。
  - `-v`, `--verify`  
    検証モードで動作します。  
    ※ファームウェアファイルの指定が必須です（`-f` オプション）。
  - `-i`, `--init`  
    初期化モードで動作します。  
    ※ファームウェアファイルの指定は不要です。

- **`-f`, `--file`**  
  **必須（アップデート・検証モードの場合）**  
  転送するファームウェアファイルのパスを指定します.  
  ※初期化モードの場合は指定不要です。

- **`-b`, `--baud`**  
  オプション  
  ボーレートの指定が可能ですが、現状内部では 115200 に固定されています。  
  ※指定された場合もエラーにはなりません。

### 4.3 ヘルプの表示

引数が不十分な場合や使い方が分からない場合は、以下のコマンドでヘルプ情報が表示されます。

```bash
python lra1_tool.py --help
```

## 5. 注意事項

- **ファームウェアファイルの要件:**  
  - サイズは 32kB 以上 120kB 以下でなければなりません。  
  - ファイル内に特定のキーが存在しない場合、アップデート対象ファイルとして認識されません。  
  エラー時は以下のメッセージが表示されます:  
  - ファイルが開けない場合:  
    `Could not open file {filename}!`  
  - アップデート対象でない場合:  
    `The file is not an update file for LRA1.`

- **シリアルポートの指定:**  
  正しいポート名（例：`/dev/ttyS0`、`COM3` など）を指定してください。  
  ポートが使用できない場合、エラーメッセージが表示されます。  
  使用する OS によってポートの表し方が異なることに注意してください。

- **モードの選択:**  
  アップデート、検証、初期化のいずれか1つを指定してください。  
  同時に複数のモードを選ぶことはできません。  
  指定がない場合、デフォルトでアップデートモードが選択されます。

- **DTRリセット:**  
  `-r` / `--reset` オプションを使用することで、転送前にデバイスの DTR 信号を操作してリセットを実施します。  
  シリアルポートの DTR で LRA1 をリセットできるハードウェアのときに機能します。  
  LRA1 はリセット直後の短時間のみ DFU モードになります。  
  ハードウェアが対応していない場合やデバイスが正しく DFU モードに入らない場合は、手動でリセットしてください。

- **ソフトウェアリセット:**  
  `-s` / `--swreset` オプションを使用することで、転送前に "RESET" コマンドを送信してリセットを実施します。  
  コマンド送信前に Break信号と Ctrl-C(0x03) を送信するので、BASICプログラムの実行は中断されます。  
  LRA1 がシリアルポートからのコマンドを受信可能な場合に有効です。  
  Sleep / Deep 実行中はシリアルポートからのコマンドの受信ができません。

- **ボーレート指定:**  
  `-b` / `--baud` オプションにより任意のボーレートを指定できますが、内部処理では 115200 が使用されます。

- **転送完了後:**  
  正常終了/エラー終了に関わらず、転送が完了すると LRA1 はハードウェアリセットを待機します。  
  ソフトウェアリセットではリセットされません。  

## 6. トラブルシューティング

- **「Could not open file」エラー:**  
  ファームウェアファイルのパスやアクセス権を確認してください。

- **「The file is not an update file for LRA1.」エラー:**  
  指定ファイルが正しいアップデート対象か、サイズおよび内容の確認を行ってください。

- **シリアルポートが開けない場合:**  
  指定したポート名が正しいか、他のアプリケーションで使用されていないか確認してください。

- **転送が始まらない場合:**  
  LRA1 のシリアルポートに正しく接続されているかどうか確認してください。  
  DTRリセットやソフトウェアリセットが無効のときは、手動で LRA1 をリセットしてください。

## 7. ライセンス

本ソフトウェア（および付随するドキュメントファイル）の著作権は ***© 2025 shachi-lab.com*** に帰属します。  
本ソフトウェアはMITライセンスに基づき、自由に利用、複製、改変、再配布することができます。  
詳細については、同梱のLICENSEファイルまたは[MITライセンス全文](https://opensource.org/licenses/MIT)を参照してください。
